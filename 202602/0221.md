## 0221 NestJS κΈ°μ΄ (4/N): μ”μ²­ μƒλ…μ£ΌκΈ° (Guard, Interceptor, Filter)

---

### β… 1. NestJS μ”μ²­ μƒλ…μ£ΌκΈ° (Request Lifecycle) κ°μ”

*   ν΄λΌμ΄μ–ΈνΈκ°€ NestJS μ„λ²„λ΅ HTTP μ”μ²­μ„ λ³΄λ‚΄λ©΄, μ΄ μ”μ²­μ€ μ»¨νΈλ΅¤λ¬μ λΌμ°νΈ ν•Έλ“¤λ¬μ— λ„λ‹¬ν•κΈ° μ „κ³Ό ν›„μ— μ—¬λ¬ λ‹¨κ³„λ¥Ό κ±°μΉκ² λ©λ‹λ‹¤.
*   NestJSλ” μ΄ κ³Όμ •μ„ μ„Έλ°€ν•κ² μ μ–΄ν•  μ μλ„λ΅ 5κ°€μ§€ μ£Όμ” κµ¬μ„± μ”μ†λ¥Ό μ κ³µν•©λ‹λ‹¤.

*   **μ‹¤ν–‰ μμ„**:
    1.  **Middleware (λ―Έλ“¤μ›¨μ–΄)**
    2.  **Guard (κ°€λ“)**
    3.  **Interceptor (μΈν„°μ…‰ν„° - Controller μ‹¤ν–‰ μ „)**
    4.  **Pipe (νμ΄ν”„)** *(μ–΄μ  ν•™μµν• μ ν¨μ„± κ²€μ¦)*
    5.  **Controller (μ»¨νΈλ΅¤λ¬ / λΉ„μ¦λ‹μ¤ λ΅μ§)**
    6.  **Interceptor (μΈν„°μ…‰ν„° - Controller μ‹¤ν–‰ ν›„)**
    7.  **Exception Filter (μμ™Έ ν•„ν„° - μ—λ¬ λ°μƒ μ‹)**

---

### β… 2. λ―Έλ“¤μ›¨μ–΄ (Middleware)

*   **κ°λ…**: Express.jsμ λ―Έλ“¤μ›¨μ–΄μ™€ λ™μΌν• κ°λ…μ…λ‹λ‹¤. λΌμ°νΈ ν•Έλ“¤λ¬κ°€ μ‹¤ν–‰λκΈ° κ°€μ¥ λ¨Όμ € μ”μ²­(Request)κ³Ό μ‘λ‹µ(Response) κ°μ²΄μ— μ ‘κ·Όν•μ—¬ μ΅°μ‘ν•  μ μμµλ‹λ‹¤.
*   **μ£Όμ” μ©λ„**:
    *   μ „μ—­μ μΈ λ΅κΉ… (μ–΄λ–¤ IPμ—μ„ μ–΄λ–¤ URLλ΅ μ”μ²­μ΄ μ™”λ”μ§€ κΈ°λ΅)
    *   μ”μ²­ ν—¤λ” κ²€μ‚¬ λ° μ΅°μ‘
*   **νΉμ§•**: NestJSμ μ‹¤ν–‰ μ»¨ν…μ¤νΈ(Execution Context)μ— μ ‘κ·Όν•  μ μ—†μ–΄, λ‹¤μμ— μ–΄λ–¤ μ»¨νΈλ΅¤λ¬κ°€ μ‹¤ν–‰λ μ§€ μ•μ§€ λ»ν•©λ‹λ‹¤.

---

### β… 3. κ°€λ“ (Guard)

*   **κ°λ…**: λ“¤μ–΄μ¨ μ”μ²­μ΄ λΌμ°νΈ ν•Έλ“¤λ¬μ— μν•΄ **μ²λ¦¬λ μ§€ λ§μ§€λ¥Ό κ²°μ •**ν•λ” μ—­ν• μ„ ν•©λ‹λ‹¤. (μ£Όλ΅ `true` λλ” `false` λ°ν™)
*   **μ£Όμ” μ©λ„**: **μΈμ¦(Authentication)**κ³Ό **μΈκ°€(Authorization)**.
    *   "μ΄ μ‚¬μ©μκ°€ λ΅κ·ΈμΈν• μ‚¬μ©μμΈκ°€?" (μΈμ¦)
    *   "μ΄ μ‚¬μ©μκ°€ κ΄€λ¦¬μ κ¶ν•μ„ κ°€μ§€κ³  μλ”κ°€?" (μΈκ°€)
*   **μ™ λ―Έλ“¤μ›¨μ–΄ λ€μ‹  κ°€λ“λ¥Ό μ“°λ”κ°€?**: λ―Έλ“¤μ›¨μ–΄λ” λ‹¤μμ— μ‹¤ν–‰λ  ν•Έλ“¤λ¬κ°€ λ¬΄μ—‡μΈμ§€ μ• μ μ—†μ§€λ§, κ°€λ“λ” `ExecutionContext`λ¥Ό ν†µν•΄ **λ‹¤μμ— μ‹¤ν–‰λ  μ»¨νΈλ΅¤λ¬μ™€ λ©”μ„λ“μ μ •λ³΄μ— μ ‘κ·Ό**ν•  μ μμ–΄ ν›¨μ”¬ μ •κµν• κ¶ν• μ μ–΄κ°€ κ°€λ¥ν•©λ‹λ‹¤.

#### β• κ°€λ“ κµ¬ν„ μμ‹ (`CanActivate` μΈν„°νμ΄μ¤)
```typescript
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Observable } from 'rxjs';

@Injectable()
export class AuthGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean | Promise<boolean> | Observable<boolean> {
    const request = context.switchToHttp().getRequest();
    // μ”μ²­ ν—¤λ”μ—μ„ ν† ν°μ„ ν™•μΈν•λ” λ΅μ§ (μμ‹)
    const hasToken = request.headers.authorization !== undefined;
    
    // trueλ¥Ό λ°ν™ν•λ©΄ μ”μ²­ ν†µκ³Ό, falseλ©΄ 403 Forbidden μ—λ¬ λ°μƒ
    return hasToken; 
  }
}

// μ»¨νΈλ΅¤λ¬μ— μ μ©
@UseGuards(AuthGuard)
@Controller('users')
export class UsersController { ... }
```

---

### β… 4. μΈν„°μ…‰ν„° (Interceptor)

*   **κ°λ…**: λ©”μ„λ“ μ‹¤ν–‰ **μ „/ν›„**μ— μ¶”κ°€ λ΅μ§μ„ λ°”μΈλ”©ν•  μ μλ” κΈ°λ¥μ…λ‹λ‹¤. AOP(κ΄€μ  μ§€ν–¥ ν”„λ΅κ·Έλλ°)μ—μ„ μκ°μ„ λ°›μ•μµλ‹λ‹¤. Springμ Interceptorλ‚ AOPμ™€ μ μ‚¬ν•©λ‹λ‹¤.
*   **μ£Όμ” μ©λ„**:
    *   **μ‘λ‹µ λ°μ΄ν„° λ³€ν™ (Response Mapping)**: μ»¨νΈλ΅¤λ¬κ°€ λ°ν™ν• λ°μ΄ν„°λ¥Ό ν΄λΌμ΄μ–ΈνΈμ—κ² λ³΄λ‚΄κΈ° μ „μ— νΉμ • ν•μ‹(e.g., `{ data: ... }`)μΌλ΅ μΌκ΄„ ν¬μ¥ν•©λ‹λ‹¤.
    *   **μ‹¤ν–‰ μ‹κ°„ μΈ΅μ •**: μ”μ²­μ΄ λ“¤μ–΄μ¨ μ‹κ°„κ³Ό μ‘λ‹µμ΄ λ‚κ°€λ” μ‹κ°„μ„ κ³„μ‚°ν•μ—¬ λ΅κΉ…ν•©λ‹λ‹¤.
    *   **μΊμ‹±**: νΉμ • μ”μ²­μ— λ€ν•΄ μ»¨νΈλ΅¤λ¬λ¥Ό μ‹¤ν–‰ν•μ§€ μ•κ³  μΊμ‹λ μ‘λ‹µμ„ λ°”λ΅ λ°ν™ν•©λ‹λ‹¤.
*   **νΉμ§•**: `RxJS`μ `Observable`μ„ μ‚¬μ©ν•μ—¬ λΉ„λ™κΈ° μ¤νΈλ¦Όμ„ κ°•λ ¥ν•κ² μ μ–΄ν•©λ‹λ‹¤.

#### β• μ‘λ‹µ λ³€ν™ μΈν„°μ…‰ν„° μμ‹
```typescript
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { map } from 'rxjs/operators';

@Injectable()
export class TransformInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler) {
    // next.handle()μ€ μ»¨νΈλ΅¤λ¬μ λΌμ°νΈ ν•Έλ“¤λ¬λ¥Ό μ‹¤ν–‰ν•¨
    return next.handle().pipe(
      // μ»¨νΈλ΅¤λ¬κ°€ λ°ν™ν• λ°μ΄ν„°(data)λ¥Ό κ°€λ΅μ±„μ„ μƒλ΅μ΄ κ°μ²΄ ν•νƒλ΅ λ³€ν™
      map(data => ({
        success: true,
        data: data,
      })),
    );
  }
}
```

---

### β… 5. μμ™Έ ν•„ν„° (Exception Filter)

*   **κ°λ…**: μ• ν”λ¦¬μΌ€μ΄μ… μ „μ—­μ—μ„ μ²λ¦¬λμ§€ μ•μ€ μμ™Έ(Unhandled Exception)κ°€ λ°μƒν–μ„ λ•, μ΄λ¥Ό κ°€λ΅μ±„μ„ **ν΄λΌμ΄μ–ΈνΈμ—κ² μΌκ΄€λ ν•νƒμ μ—λ¬ μ‘λ‹µμ„ λ³΄λ‚΄λ” μ—­ν• **μ„ ν•©λ‹λ‹¤. Springμ `@RestControllerAdvice`μ™€ λ™μΌν• μ—­ν• μ…λ‹λ‹¤.
*   **μ£Όμ” μ©λ„**:
    *   μ—λ¬ λ©”μ‹μ§€ ν¬λ§· ν†µμΌ (e.g., `{ statusCode: 400, message: "...", timestamp: "..." }`)
    *   μ—λ¬ λ΅κΉ… μ¤‘μ•™ν™”

#### β• μμ™Έ ν•„ν„° κµ¬ν„ μμ‹
```typescript
import { ExceptionFilter, Catch, ArgumentsHost, HttpException } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch(HttpException) // HttpException νƒ€μ…μ μ—λ¬λ§ κ°€λ΅μ±”
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();
    const status = exception.getStatus();

    // μ»¤μ¤ν…€ μ—λ¬ μ‘λ‹µ ν¬λ§· μ •μ
    response.status(status).json({
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      message: exception.message,
    });
  }
}
```

---

### π“ μ”μ•½

*   NestJSλ” μ”μ²­μ΄ λ“¤μ–΄μ¤κ³  λ‚κ°€λ” κ³Όμ •μ„ μ„Έλ°€ν•κ² μ μ–΄ν•  μ μλ” **μƒλ…μ£ΌκΈ°(Lifecycle)**λ¥Ό μ κ³µν•©λ‹λ‹¤.
*   **Middleware**λ” λΌμ°νΈ λ„λ‹¬ μ „ μ „μ—­μ μΈ μ²λ¦¬λ¥Ό λ‹΄λ‹Ήν•©λ‹λ‹¤.
*   **Guard**λ” `ExecutionContext`λ¥Ό ν™μ©ν•μ—¬ μ”μ²­μ **μΈμ¦ λ° μΈκ°€(κ¶ν• μ μ–΄)**λ¥Ό μν–‰ν•©λ‹λ‹¤.
*   **Interceptor**λ” λΌμ°νΈ ν•Έλ“¤λ¬ μ‹¤ν–‰ μ „ν›„μ— κ°μ…ν•μ—¬ **μ‘λ‹µ λ°μ΄ν„°λ¥Ό λ³€ν™**ν•κ±°λ‚ λ΅κΉ… λ“±μ λ¶€κ°€ κΈ°λ¥μ„ μν–‰ν•©λ‹λ‹¤.
*   **Exception Filter**λ” μ•± μ „μ—­μ—μ„ λ°μƒν•λ” μ—λ¬λ¥Ό κ°€λ΅μ±„μ–΄ **μΌκ΄€λ μ—λ¬ μ‘λ‹µ ν¬λ§·**μ„ ν΄λΌμ΄μ–ΈνΈμ—κ² μ κ³µν•©λ‹λ‹¤.