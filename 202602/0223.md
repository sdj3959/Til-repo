## 0223 NestJS κΈ°μ΄ (5/N): GraphQLκ³Όμ λ§λ‚¨

---

### β… 1. GraphQLμ΄λ€ λ¬΄μ—‡μΈκ°€? (REST APIμ λ€μ•)

*   **GraphQL**μ€ νμ΄μ¤λ¶(ν„ λ©”νƒ€)μ—μ„ κ°λ°ν•, APIλ¥Ό μ„ν• **μΏΌλ¦¬ μ–Έμ–΄(Query Language)**μ΄μ ν•΄λ‹Ή μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•κΈ° μ„ν• **λ°νƒ€μ„**μ…λ‹λ‹¤. REST APIμ λ‡ κ°€μ§€ λ¬Έμ μ μ„ ν•΄κ²°ν•κΈ° μ„ν•΄ λ“±μ¥ν–μµλ‹λ‹¤.

*   **REST APIμ λ¬Έμ μ **:
    1.  **Over-fetching**: νΉμ • μ—”λ“ν¬μΈνΈκ°€ ν•­μƒ μ •ν•΄μ§„ λ°μ΄ν„° κµ¬μ΅° μ „μ²΄λ¥Ό λ°ν™ν•λ―€λ΅, ν΄λΌμ΄μ–ΈνΈκ°€ **ν•„μ”ν•μ§€ μ•μ€ λ°μ΄ν„°κΉμ§€** λ°›μ•„μ™€μ•Ό ν•λ” λ‚­λΉ„κ°€ λ°μƒν•©λ‹λ‹¤. (e.g., μ‚¬μ©μμ `μ΄λ¦„`λ§ ν•„μ”ν•λ°, `λ‚μ΄`, `μ£Όμ†`, `κ°€μ…μΌ`κΉμ§€ λ¨λ‘ λ°›μ•„μ΄)
    2.  **Under-fetching**: ν•λ‚μ ν™”λ©΄μ„ κµ¬μ„±ν•κΈ° μ„ν•΄ **μ—¬λ¬ λ²μ API μ”μ²­**μ΄ ν•„μ”ν• κ²½μ°κ°€ λ°μƒν•©λ‹λ‹¤. (e.g., κ²μ‹κΈ€ μ •λ³΄λ¥Ό κ°€μ Έμ¨ ν›„, λ‹¤μ‹ λ“κΈ€ μ •λ³΄λ¥Ό κ°€μ Έμ¤κ³ , λ μ‚¬μ©μ μ •λ³΄λ¥Ό κ°€μ Έμ¤λ” λ“±)
    3.  **κ²½μ§λ μ—”λ“ν¬μΈνΈ**: ν΄λΌμ΄μ–ΈνΈμ μ”κµ¬μ‚¬ν•­μ΄ λ³€κ²½λ  λ•λ§λ‹¤ μƒλ΅μ΄ μ—”λ“ν¬μΈνΈλ¥Ό λ§λ“¤κ±°λ‚ κΈ°μ΅΄ μ—”λ“ν¬μΈνΈλ¥Ό μμ •ν•΄μ•Ό ν•©λ‹λ‹¤.

*   **GraphQLμ ν•΄κ²°μ±…**:
    *   GraphQLμ€ **λ‹¨ ν•λ‚μ μ—”λ“ν¬μΈνΈ**(`/graphql`)λ¥Ό μ‚¬μ©ν•©λ‹λ‹¤.
    *   ν΄λΌμ΄μ–ΈνΈλ” μ΄ μ—”λ“ν¬μΈνΈμ— **"λ‚΄κ°€ ν•„μ”ν• λ°μ΄ν„°μ κµ¬μ΅°"**λ¥Ό **μΏΌλ¦¬(Query)** ν•νƒλ΅ λ‹΄μ•„ λ³΄λƒ…λ‹λ‹¤.
    *   μ„λ²„λ” μ΄ μΏΌλ¦¬λ¥Ό ν•΄μ„ν•μ—¬, ν΄λΌμ΄μ–ΈνΈκ°€ **μ”μ²­ν• κ·Έλ€λ΅μ κµ¬μ΅°μ™€ λ°μ΄ν„°λ§**μ„ μ •ν™•ν•κ² λ°ν™ν•©λ‹λ‹¤.

    ```graphql
    # ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ— λ³΄λ‚΄λ” μΏΌλ¦¬
    query {
      user(id: "1") {
        name
        email
        posts {
          title
        }
      }
    }

    # μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ—κ² λ³΄λ‚΄λ” μ‘λ‹µ (JSON)
    {
      "data": {
        "user": {
          "name": "Alice",
          "email": "alice@example.com",
          "posts": [
            { "title": "My first post" },
            { "title": "GraphQL is awesome" }
          ]
        }
      }
    }
    ```

---

### β… 2. GraphQLμ 3κ°€μ§€ ν•µμ‹¬ μ‘μ—… (Operation)

1.  **Query**: λ°μ΄ν„°λ¥Ό **μ½λ”(Read)** μ‘μ—…. RESTμ `GET`κ³Ό μ μ‚¬ν•©λ‹λ‹¤.
2.  **Mutation**: λ°μ΄ν„°λ¥Ό **μƒμ„±(Create), μμ •(Update), μ‚­μ (Delete)**ν•λ” μ‘μ—…. RESTμ `POST`, `PUT`, `DELETE`λ¥Ό ν•©μΉ κ²ƒκ³Ό μ μ‚¬ν•©λ‹λ‹¤.
3.  **Subscription**: νΉμ • μ΄λ²¤νΈκ°€ λ°μƒν–μ„ λ•, μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ—κ² **μ‹¤μ‹κ°„μΌλ΅ λ°μ΄ν„°λ¥Ό ν‘Έμ‹(Push)**ν•λ” μ‘μ—…. (WebSocket κΈ°λ°)

---

### β… 3. NestJSμ—μ„ GraphQL μ„λ²„ κµ¬μ¶•ν•κΈ°

*   NestJSλ” `@nestjs/graphql`κ³Ό `@nestjs/apollo` ν¨ν‚¤μ§€λ¥Ό ν†µν•΄ GraphQL μ„λ²„λ¥Ό λ§¤μ° μ‰½κ³  κµ¬μ΅°μ μΌλ΅ κµ¬μ¶•ν•  μ μλ„λ΅ μ§€μ›ν•©λ‹λ‹¤.

#### β• 3-1. ν•„μ”ν• ν¨ν‚¤μ§€ μ„¤μΉ
```bash
npm install @nestjs/graphql @nestjs/apollo graphql apollo-server-express
```

#### β• 3-2. λ£¨νΈ λ¨λ“(`app.module.ts`)μ— `GraphQLModule` λ“±λ΅

*   `GraphQLModule.forRoot()`λ¥Ό μ‚¬μ©ν•μ—¬ GraphQL μ„λ²„μ κΈ°λ³Έ μ„¤μ •μ„ κµ¬μ„±ν•©λ‹λ‹¤.
    *   **`autoSchemaFile: true`**: μ½”λ“(TypeScript ν΄λμ¤)λ¥Ό κΈ°λ°μΌλ΅ **GraphQL μ¤ν‚¤λ§ νμΌ(`schema.gql`)μ„ μλ™μΌλ΅ μƒμ„±**ν•΄μ£Όλ” λ§¤μ° κ°•λ ¥ν• μµμ…μ…λ‹λ‹¤. (Code-First μ ‘κ·Ό λ°©μ‹)
    *   **`driver: ApolloDriver`**: GraphQL μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•  μ—”μ§„μΌλ΅ Apollo Serverλ¥Ό μ‚¬μ©ν•λ„λ΅ μ§€μ •ν•©λ‹λ‹¤.

    ```typescript
    // app.module.ts
    import { GraphQLModule } from '@nestjs/graphql';
    import { ApolloDriver } from '@nestjs/apollo';

    @Module({
      imports: [
        GraphQLModule.forRoot({
          driver: ApolloDriver,
          autoSchemaFile: true,
        }),
      ],
    })
    export class AppModule {}
    ```

#### β• 3-3. μ¤ν‚¤λ§ μ •μ: DTOμ™€ `@ObjectType`

*   GraphQL μ¤ν‚¤λ§μ—μ„ μ‚¬μ©λ  λ°μ΄ν„° νƒ€μ…μ„ μ •μν•©λ‹λ‹¤. NestJSμ—μ„λ” `@ObjectType()` λ°μ½”λ μ΄ν„°κ°€ λ¶™μ€ ν΄λμ¤λ¥Ό μ‚¬μ©ν•μ—¬ μ΄λ¥Ό μ •μν•©λ‹λ‹¤.
*   **`@Field()`**: μ™Έλ¶€λ΅ λ…Έμ¶λ  ν•„λ“λ¥Ό λ…μ‹ν•©λ‹λ‹¤.

    ```typescript
    // movie.dto.ts
    import { ObjectType, Field, Int } from '@nestjs/graphql';

    @ObjectType() // μ΄ ν΄λμ¤κ°€ GraphQLμ νƒ€μ…μ„μ„ μ„ μ–Έ
    export class Movie {
      @Field(() => Int)
      id: number;

      @Field()
      title: string;

      @Field(() => Int)
      year: number;
    }
    ```

#### β• 3-4. λ¦¬μ΅Έλ²„ (Resolver) κµ¬ν„

*   **λ¦¬μ΅Έλ²„**λ” νΉμ • GraphQL **μΏΌλ¦¬λ‚ λ®¤ν…μ΄μ…μ— λ€ν• μ‹¤μ  μ²λ¦¬ λ΅μ§**μ„ λ‹΄κ³  μλ” ν΄λμ¤μ…λ‹λ‹¤. RESTμ μ»¨νΈλ΅¤λ¬μ™€ μ μ‚¬ν• μ—­ν• μ„ ν•©λ‹λ‹¤.
*   **`@Resolver()`**: μ΄ ν΄λμ¤κ°€ λ¦¬μ΅Έλ²„μ„μ„ μ„ μ–Έν•©λ‹λ‹¤.
*   **`@Query()`**: μΏΌλ¦¬ ν•Έλ“¤λ¬μ„μ„ λ‚νƒ€λƒ…λ‹λ‹¤.
*   **`@Mutation()`**: λ®¤ν…μ΄μ… ν•Έλ“¤λ¬μ„μ„ λ‚νƒ€λƒ…λ‹λ‹¤.
*   **`@Args()`**: μΏΌλ¦¬λ‚ λ®¤ν…μ΄μ…μ— μ „λ‹¬λ μΈμ(arguments)λ¥Ό κ°€μ Έμµλ‹λ‹¤.

    ```typescript
    // movies.resolver.ts
    import { Resolver, Query, Args, Mutation } from '@nestjs/graphql';
    import { Movie } from './dto/movie.dto';
    import { MoviesService } from './movies.service';

    @Resolver()
    export class MoviesResolver {
      constructor(private readonly moviesService: MoviesService) {}

      @Query(() => [Movie]) // μ΄ λ©”μ„λ“κ°€ [Movie] νƒ€μ…μ„ λ°ν™ν•λ” μΏΌλ¦¬μ„μ„ μ„ μ–Έ
      movies(): Movie[] {
        return this.moviesService.getAll();
      }

      @Mutation(() => Boolean)
      createMovie(@Args('title') title: string): boolean {
        // ... μν™” μƒμ„± λ΅μ§ ...
        return true;
      }
    }
    ```

---

### π“ μ”μ•½

*   **GraphQL**μ€ ν΄λΌμ΄μ–ΈνΈκ°€ **ν•„μ”ν• λ°μ΄ν„°λ§, μ›ν•λ” κµ¬μ΅°λ΅, ν• λ²μ μ”μ²­**μΌλ΅ κ°€μ Έμ¬ μ μκ² ν•΄μ£Όλ” ν„λ€μ μΈ API μΏΌλ¦¬ μ–Έμ–΄μ…λ‹λ‹¤.
*   GraphQLμ μ£Όμ” μ‘μ—…μ€ **`Query`(μ½κΈ°)**, **`Mutation`(μ“°κΈ°)**, **`Subscription`(μ‹¤μ‹κ°„)**μΌλ΅ λ‚λ‰©λ‹λ‹¤.
*   NestJSμ—μ„λ” **Code-First** μ ‘κ·Ό λ°©μ‹μ„ ν†µν•΄, TypeScript ν΄λμ¤μ™€ λ°μ½”λ μ΄ν„°(**`@ObjectType`, `@Field`**)λ΅ μ¤ν‚¤λ§λ¥Ό μ •μν•λ©΄, **GraphQL μ¤ν‚¤λ§ νμΌμ΄ μλ™μΌλ΅ μƒμ„±**λ©λ‹λ‹¤.
*   **λ¦¬μ΅Έλ²„(`@Resolver`)**λ” RESTμ μ»¨νΈλ΅¤λ¬μ™€ μ μ‚¬ν• μ—­ν• μ„ ν•λ©°, **`@Query`**μ™€ **`@Mutation`** λ°μ½”λ μ΄ν„°κ°€ λ¶™μ€ λ©”μ„λ“μ—μ„ μ‹¤μ  λ°μ΄ν„° μ²λ¦¬ λ΅μ§μ„ κµ¬ν„ν•©λ‹λ‹¤.